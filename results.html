<script>
document.addEventListener("DOMContentLoaded", function () {
  // ------------------------------
  // Get calculator + lead data from sessionStorage
  // ------------------------------
  const resultsData = JSON.parse(sessionStorage.getItem("calc_results") || "{}");

  // Fallbacks if sessionStorage empty
  const address = resultsData.address || "Atlanta, GA";
  const riskScore = resultsData.riskScore || 85;

  // Display risk score
  const riskEl = document.getElementById("riskScore");
  if (riskEl) riskEl.textContent = riskScore;

  // Optional: display lead info
  const leadNameEl = document.getElementById("leadName");
  if (leadNameEl) leadNameEl.textContent = `${resultsData.firstname || ""} ${resultsData.lastname || ""}`;
  const emailEl = document.getElementById("leadEmail");
  if (emailEl) emailEl.textContent = resultsData.email || "";

  // ------------------------------
  // Load Google Maps async safely
  // ------------------------------
  function loadGoogleMaps() {
    if (window.google && window.google.maps) {
      initMap();
      return;
    }

    const script = document.createElement("script");
    script.src = "https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_KEY}}&libraries=visualization,marker&callback=initMap";
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }

  // ------------------------------
  // Initialize Map with marker
  // ------------------------------
  window.initMap = function () {
    const geocoder = new google.maps.Geocoder();

    geocoder.geocode({ address: address }, function (results, status) {
      if (status !== "OK" || !results[0]) {
        console.error("Geocode failed:", status);
        return;
      }

      const loc = results[0].geometry.location;

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: loc,
        mapId: "DEMO_MAP_ID" // replace with your actual map ID
      });

      new google.maps.marker.AdvancedMarkerElement({
        map: map,
        position: loc
      });
    });
  };

  loadGoogleMaps();
});
</script>
