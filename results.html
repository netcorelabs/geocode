<section class="hsc-results">

  <div class="result-grid">

    <div class="score-card">
      <h2 id="riskScore">--</h2>
      <p>Security Readiness Score</p>
    </div>

    <div class="map-card">
      <div id="map" style="width:100%;height:450px;border-radius:20px;"></div>
    </div>

  </div>

</section>

<style>
.hsc-results {
  padding:60px;
  background:linear-gradient(135deg,#ffffff,#e0f2fe);
  font-family:"Segoe UI", sans-serif;
}
.result-grid {
  display:grid;
  gap:40px;
  grid-template-columns: 1fr 2fr;
}
.score-card {
  background:linear-gradient(135deg,#1e3a8a,#0ea5e9);
  color:white;
  padding:40px;
  border-radius:20px;
  text-align:center;
}
#riskScore { font-size:70px; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){

  // ------------------------------
  // Pull lead + calculator data
  // ------------------------------
  const leadData = JSON.parse(sessionStorage.getItem("lead_data") || "{}");
  const calcData = JSON.parse(sessionStorage.getItem("calc_results") || "{}");

  const address = leadData.address || calcData.address || "Atlanta, GA";
  const riskScore = calcData.riskScore || 85;

  document.getElementById("riskScore").textContent = riskScore;

  // ------------------------------
  // Load Google Maps async
  // ------------------------------
  function loadGoogle(){
    if(window.google && window.google.maps) {
      initMap();
      return;
    }
    const s = document.createElement("script");
    s.src = "https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_KEY&libraries=visualization";
    s.async = true;
    s.defer = true;
    s.onload = initMap;
    document.head.appendChild(s);
  }

  function initMap(){
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({address: address}, function(results, status){
      if(status !== "OK" || !results[0]){
        console.error("Geocode failed", status);
        return;
      }

      const loc = results[0].geometry.location;

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: loc
      });

      new google.maps.Marker({
        position: loc,
        map: map
      });

      fetchCrimeData(map, loc);
    });
  }

  // ------------------------------
  // Fetch FBI Crime data for heatmap overlay
  // ------------------------------
  async function fetchCrimeData(map, loc){
    try {
      const state = "GA"; // optionally auto-detect
      const year = "2022";

      const res = await fetch(
        `https://api.usa.gov/crime/fbi/sapi/api/summarized/state/${state}/violent-crime/${year}/${year}?api_key=YOUR_FBI_KEY`
      );

      const data = await res.json();
      if(!data.results) return;

      const heatPoints = [];
      data.results.forEach(r => {
        const latOffset = loc.lat() + (Math.random() - 0.5) * 0.15;
        const lngOffset = loc.lng() + (Math.random() - 0.5) * 0.15;
        heatPoints.push(new google.maps.LatLng(latOffset, lngOffset));
      });

      const heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatPoints,
        radius: 35
      });

      heatmap.setMap(map);

    } catch(e){
      console.error("FBI API error", e);
    }
  }

  loadGoogle();

});
</script>
