<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Home Security Quote Results</title>

<style>
:root {
  --primary:#0b1c2d;
  --accent:#2563eb;
  --bg:#f7f9fb;
  --text:#1f2937;
  --radius:10px;
}

body {
  margin:0;
  font-family:"Segoe UI", sans-serif;
  background:var(--bg);
  color:var(--text);
}

.results-container {
  max-width:1200px;
  margin:auto;
  padding:40px;
}

h1,h2 {
  color:var(--primary);
}

.cards {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:20px;
}

.card {
  background:#fff;
  border-radius:var(--radius);
  padding:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
}

.card h3 {
  margin:0 0 10px;
  color:var(--primary);
}

#map {
  width:100%;
  height:450px;
  border-radius:var(--radius);
}

.total-value {
  font-size:28px;
  font-weight:600;
  margin-bottom:6px;
}

.device-list {
  font-size:14px;
  color:#555;
}
</style>
</head>

<body>

<div class="results-container">
  <h1>Your Smart Home Security Quote</h1>

  <div class="cards">
    <div class="card">
      <h3>Totals</h3>
      <div class="total-value" id="upfront">$0 Upfront</div>
      <div class="total-value" id="monthly">$0 / month</div>
      <div class="device-list" id="device-summary">No devices selected</div>
    </div>

    <div class="card">
      <h3>Property Map</h3>
      <div id="map">Loading map...</div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function(){

  const leadData = JSON.parse(sessionStorage.getItem("lead_data") || "{}");
  const homeValue = localStorage.getItem("calc_home_value") || "--";
  const securityLevel = localStorage.getItem("calc_security_level") || "standard";
  const address = leadData.address || "1600 Amphitheatre Parkway, Mountain View, CA";

  let score = 85;
  if(homeValue && securityLevel){
    const valueFactor = Math.min(homeValue / 500000 * 100, 100);
    const levelFactor = securityLevel === "premium" ? -15 : securityLevel === "basic" ? 10 : 0;
    score = Math.round(85 - valueFactor*0.1 + levelFactor);
  }
  document.getElementById("riskScore").textContent = score;

  // ðŸ” Load Google Maps (restricted by domain in Google Console)
  function loadGoogleMaps() {
    const s = document.createElement("script");
    s.src = "https://maps.googleapis.com/maps/api/js?key=YOUR_RESTRICTED_GOOGLE_KEY&libraries=visualization";
    s.async = true;
    s.onload = initMap;
    document.head.appendChild(s);
  }

  function initMap() {
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({address: address}, function(results, status){
      if(status !== "OK" || !results[0]) return;

      const loc = results[0].geometry.location;

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: loc
      });

      new google.maps.Marker({
        position: loc,
        map: map
      });

      fetchCrimeData(map, loc);
    });
  }

  async function fetchCrimeData(map, loc){
    try {
      const res = await fetch("/.netlify/functions/get-crime-data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          state: "GA",
          year: "2022"
        })
      });

      const data = await res.json();
      if(!data.results) return;

      const heatPoints = [];
      data.results.forEach(r => {
        const latOffset = loc.lat() + (Math.random() - 0.5) * 0.15;
        const lngOffset = loc.lng() + (Math.random() - 0.5) * 0.15;
        heatPoints.push(new google.maps.LatLng(latOffset, lngOffset));
      });

      const heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatPoints,
        radius: 35
      });

      heatmap.setMap(map);

    } catch(e){
      console.error("Crime API error", e);
    }
  }

  loadGoogleMaps();
});
</script>

  // ===== Load calculator data =====
  const calcData = JSON.parse(sessionStorage.getItem("calc_data")||"{}");

  document.getElementById("upfront").textContent = `$${Math.round(calcData.upfront||0)} Upfront`;
  document.getElementById("monthly").textContent = `$${calcData.monthly||0}/month`;
  document.getElementById("device-summary").textContent = calcData.summary && calcData.summary.length ? calcData.summary.join(", ") : "No devices selected";

  // ===== Load Google Map =====
  const address = calcData.address || "1600 Amphitheatre Parkway, Mountain View, CA"; // fallback
  function loadGoogleMaps(){
    const s = document.createElement("script");
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_KEY}&libraries=visualization,places&callback=initMap`;
    s.async = true;
    document.head.appendChild(s);
  }

  window.initMap = function(){
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({address: address}, function(results, status){
      if(status !== "OK" || !results[0]){
        document.getElementById("map").textContent = "Unable to load map for this address";
        return;
      }
      const loc = results[0].geometry.location;

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: loc
      });

      new google.maps.Marker({
        position: loc,
        map: map
      });

      loadCrimeHeatmap(map, loc);
    });
  }

  // ===== Sample crime heatmap (replace with your API) =====
  async function loadCrimeHeatmap(map, loc){
    try {
      // Replace with your real FBI/Crime API or Netlify function
      const heatPoints = [];
      for(let i=0;i<50;i++){
        const latOffset = loc.lat() + (Math.random()-0.5)*0.02;
        const lngOffset = loc.lng() + (Math.random()-0.5)*0.02;
        heatPoints.push(new google.maps.LatLng(latOffset,lngOffset));
      }

      const heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatPoints,
        radius: 30
      });

      heatmap.setMap(map);

    } catch(e){
      console.error("Error loading heatmap", e);
    }
  }

  loadGoogleMaps();

});
</script>

</body>
</html>
